{% extends "base.html" %}
{% block content %}
<h1>üìã Liste des consommations √©nerg√©tiques</h1>

<div class="card">
  <form method="get" action="/list" class="row wrap" id="filterForm">
    <fieldset style="border: none; padding: 0; margin: 0; display: contents;">
      <legend class="sr-only">Filtre par cat√©gorie</legend>
      
      <div class="field inline" style="width: auto;">
        <label for="categoryFilter">Filtrer par cat√©gorie</label>
        <select id="categoryFilter" name="category_id" aria-describedby="filter-hint">
          <option value="">Toutes les cat√©gories</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if selected_category_id == c.id %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field inline" style="width: auto;">
        <label for="yearFilter">Filtrer par ann√©e</label>
        <select id="yearFilter" name="year" aria-describedby="year-hint year-error">
          <option value="all" {% if selected_year == 'all' %}selected{% endif %}>Toutes les ann√©es</option>
          {% for y in years %}
            <option value="{{ y }}" {% if selected_year == y|string %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>
      <button class="btn secondary" type="submit" title="Appliquer le filtre">üîç Filtrer</button>
      <a class="btn primary" href="/form" title="Ajouter un nouvel enregistrement">‚ûï Ajouter</a>
    </fieldset>
  </form>

<script>
  document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const categoryId = document.getElementById('categoryFilter').value;
    const year = document.getElementById('yearFilter').value;
    const yearError = document.getElementById('year-error');

    // Erreur si ann√©e non s√©lectionn√©e
    if (year === '') {
      if (yearError) yearError.style.display = 'inline';
      document.getElementById('yearFilter').focus();
      return;
    }
    if (yearError) yearError.style.display = 'none';

    const url = new URL(window.location.origin + "/list");

    if (categoryId !== '') {
      url.searchParams.set('category_id', categoryId);
    }

    if (year !== 'all') {
      url.searchParams.set('year', year);
    }

    window.location.href = url.toString();
  });
</script>

<div class="card">
  <table class="table" role="grid" aria-label="Table des consommations √©nerg√©tiques">
    <thead>
      <tr>
        <th scope="col">#ID</th>
        <th scope="col">Ann√©e</th>
        <th scope="col">Cat√©gorie</th>
        <th scope="col" style="text-align: right;">Consommation (kWh)</th>
        <th scope="col" style="text-align: right;">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% if rows|length == 0 %}
        <tr>
          <td colspan="5" class="muted">
            <p>Aucune donn√©e enregistr√©e.</p>
            <a href="/form" class="btn primary small">Enregistrer une consommation ‚Üí</a>
          </td>
        </tr>
      {% else %}
        {% for r in rows %}
          <tr>
            <td><code>{{ r.id }}</code></td>
            <td>{{ r.year }}</td>
            <td>
              <div class="tags">
                <span class="tag primary">{{ r.category }}</span>
                {% if r.subcategory %}
                  <span class="tag success">{{ r.subcategory }}</span>
                {% endif %}
              </div>
            </td>
            <td style="text-align: right; font-weight: 600;">{{ "%.2f"|format(r.value_kwh) }}</td>
            <td style="text-align: right;">
              <form method="post" action="/records/{{ r.id }}/delete"
                    onsubmit="return confirm('Supprimer d√©finitivement cette entr√©e (#{{ r.id }}) ?');"
                    style="display:inline;">
                <input type="hidden" name="category_id" value="{{ selected_category_id or '' }}">
                <input type="hidden" name="year" value="{{ selected_year or '' }}">
                <button class="btn danger small" type="submit" title="Supprimer cette entr√©e">üóë Supprimer</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      {% endif %}
    </tbody>
  </table>
</div>
{% endblock %}
